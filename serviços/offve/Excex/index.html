<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planilha Interativa</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }

        body {
            background-color: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        header {
            background-color: #2c3e50;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            font-size: 1.5rem;
        }

        .toolbar {
            background-color: #ecf0f1;
            padding: 10px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        button {
            padding: 8px 12px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        button:hover {
            background-color: #2980b9;
        }

        .format-options {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        select, input {
            padding: 6px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .main-content {
            display: flex;
            flex-direction: column;
            padding: 20px;
        }

        .spreadsheet {
            overflow: auto;
            border: 1px solid #ccc;
            margin-bottom: 20px;
        }

        table {
            border-collapse: collapse;
            min-width: 100%;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            min-width: 100px;
        }

        th {
            background-color: #f2f2f2;
            position: sticky;
            top: 0;
        }

        td {
            background-color: white;
        }

        td:focus {
            outline: 2px solid #3498db;
        }

        .chart-container {
            margin-top: 20px;
            height: 400px;
            border: 1px solid #ccc;
            padding: 10px;
            background-color: #f9f9f9;
        }

        #chartCanvas {
            width: 100%;
            height: 100%;
        }

        .status-bar {
            background-color: #ecf0f1;
            padding: 10px;
            text-align: right;
            font-size: 14px;
            color: #7f8c8d;
        }

        .formula-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .formula-bar input {
            flex: 1;
            padding: 10px;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Planilha Interativa</h1>
            <button id="saveBtn">Salvar (.xlsx)</button>
        </header>

        <div class="toolbar">
            <div>
                <label>Formato: </label>
                <select id="numberFormat">
                    <option value="general">Geral</option>
                    <option value="currency">Moeda</option>
                    <option value="percentage">Porcentagem</option>
                    <option value="date">Data</option>
                </select>
            </div>
            <div>
                <label>Cor de Fundo: </label>
                <input type="color" id="bgColor" value="#ffffff">
            </div>
            <div>
                <label>Cor da Fonte: </label>
                <input type="color" id="fontColor" value="#000000">
            </div>
            <div>
                <button id="sortBtn">Ordenar Coluna</button>
                <button id="filterBtn">Filtrar Dados</button>
            </div>
            <div>
                <label>Tipo de Gráfico: </label>
                <select id="chartType">
                    <option value="bar">Barras</option>
                    <option value="line">Linhas</option>
                    <option value="pie">Pizza</option>
                </select>
                <button id="createChartBtn">Criar Gráfico</button>
            </div>
        </div>

        <div class="main-content">
            <div class="formula-bar">
                <label for="formulaInput">Fórmula:</label>
                <input type="text" id="formulaInput" placeholder="Ex: =SOMA(A1:A3)">
            </div>

            <div class="spreadsheet">
                <table id="spreadsheetTable">
                    <thead>
                        <tr>
                            <th></th>
                            <th>A</th>
                            <th>B</th>
                            <th>C</th>
                            <th>D</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>1</td>
                            <td contenteditable="true">10</td>
                            <td contenteditable="true">20</td>
                            <td contenteditable="true">30</td>
                            <td contenteditable="true"></td>
                        </tr>
                        <tr>
                            <td>2</td>
                            <td contenteditable="true">40</td>
                            <td contenteditable="true">50</td>
                            <td contenteditable="true">60</td>
                            <td contenteditable="true"></td>
                        </tr>
                        <tr>
                            <td>3</td>
                            <td contenteditable="true">70</td>
                            <td contenteditable="true">80</td>
                            <td contenteditable="true">90</td>
                            <td contenteditable="true"></td>
                        </tr>
                        <tr>
                            <td>4</td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                        </tr>
                        <tr>
                            <td>5</td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="chart-container">
                <canvas id="chartCanvas"></canvas>
            </div>
        </div>

        <div class="status-bar">
            <span id="status">Pronto</span>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Dados da planilha
        let sheetData = [
            [10, 20, 30, ""],
            [40, 50, 60, ""],
            [70, 80, 90, ""],
            ["", "", "", ""],
            ["", "", "", ""]
        ];

        // Elementos do DOM
        const table = document.getElementById('spreadsheetTable');
        const formulaInput = document.getElementById('formulaInput');
        const numberFormat = document.getElementById('numberFormat');
        const bgColor = document.getElementById('bgColor');
        const fontColor = document.getElementById('fontColor');
        const sortBtn = document.getElementById('sortBtn');
        const filterBtn = document.getElementById('filterBtn');
        const chartType = document.getElementById('chartType');
        const createChartBtn = document.getElementById('createChartBtn');
        const saveBtn = document.getElementById('saveBtn');
        const status = document.getElementById('status');

        // Atualiza os dados da planilha ao editar células
        table.addEventListener('input', function(e) {
            if (e.target.tagName === 'TD') {
                const row = e.target.parentElement.rowIndex - 1;
                const col = e.target.cellIndex - 1;
                if (row >= 0 && col >= 0) {
                    sheetData[row][col] = e.target.textContent;
                    evaluateFormulas();
                    updateStatus(`Célula ${String.fromCharCode(65 + col)}${row + 1} atualizada`);
                }
            }
        });

        // Avalia fórmulas
        function evaluateFormulas() {
            for (let row = 0; row < sheetData.length; row++) {
                for (let col = 0; col < sheetData[row].length; col++) {
                    const cellValue = sheetData[row][col];
                    if (typeof cellValue === 'string' && cellValue.startsWith('=')) {
                        try {
                            const result = evaluateFormula(cellValue);
                            sheetData[row][col] = result;
                            // Atualiza a célula na tabela
                            const cell = table.rows[row + 1].cells[col + 1];
                            cell.textContent = formatValue(result, numberFormat.value);
                        } catch (error) {
                            console.error('Erro na fórmula:', error);
                        }
                    }
                }
            }
        }

        // Função para avaliar fórmulas simples
        function evaluateFormula(formula) {
            // Remove o '='
            let expr = formula.substring(1).toUpperCase();

            // Substitui referências de células por valores
            expr = expr.replace(/([A-Z])(\d+)/g, (match, col, row) => {
                const colIndex = col.charCodeAt(0) - 65;
                const rowIndex = parseInt(row) - 1;
                if (rowIndex >= 0 && rowIndex < sheetData.length && 
                    colIndex >= 0 && colIndex < sheetData[rowIndex].length) {
                    const value = sheetData[rowIndex][colIndex];
                    return typeof value === 'number' ? value : 0;
                }
                return 0;
            });

            // Substitui funções
            expr = expr.replace(/SOMA/g, 'SUM');
            expr = expr.replace(/MÉDIA/g, 'AVERAGE');
            expr = expr.replace(/MEDIA/g, 'AVERAGE');

            // Avalia expressões com funções
            if (expr.startsWith('SUM(') || expr.startsWith('AVERAGE(')) {
                const func = expr.substring(0, expr.indexOf('('));
                const range = expr.substring(expr.indexOf('(') + 1, expr.indexOf(')'));
                const values = getRangeValues(range);
                if (func === 'SUM') {
                    return values.reduce((a, b) => a + b, 0);
                } else if (func === 'AVERAGE') {
                    return values.length ? values.reduce((a, b) => a + b, 0) / values.length : 0;
                }
            }

            // Avaliação básica (não segura para produção, apenas para demonstração)
            try {
                // Substitui operadores
                expr = expr.replace(/ /g, '');
                return Function('"use strict"; return (' + expr + ')')();
            } catch (e) {
                return '#ERRO!';
            }
        }

        // Obtém valores de um intervalo (ex: A1:B3)
        function getRangeValues(range) {
            const values = [];
            if (range.includes(':')) {
                const [start, end] = range.split(':');
                const startCol = start.charCodeAt(0) - 65;
                const startRow = parseInt(start.substring(1)) - 1;
                const endCol = end.charCodeAt(0) - 65;
                const endRow = parseInt(end.substring(1)) - 1;

                for (let r = startRow; r <= endRow; r++) {
                    for (let c = startCol; c <= endCol; c++) {
                        if (r >= 0 && r < sheetData.length && c >= 0 && c < sheetData[r].length) {
                            const val = sheetData[r][c];
                            if (typeof val === 'number') {
                                values.push(val);
                            }
                        }
                    }
                }
            }
            return values;
        }

        // Formata valor de acordo com o tipo
        function formatValue(value, format) {
            if (typeof value !== 'number') return value;

            switch (format) {
                case 'currency':
                    return value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                case 'percentage':
                    return (value * 100).toFixed(2) + '%';
                case 'date':
                    return new Date(value).toLocaleDateString('pt-BR');
                default:
                    return value.toString();
            }
        }

        // Aplica formatação às células selecionadas
        function applyFormatting() {
            const cells = table.querySelectorAll('td[contenteditable="true"]');
            cells.forEach(cell => {
                cell.style.backgroundColor = bgColor.value;
                cell.style.color = fontColor.value;
                // Atualiza o valor formatado
                const row = cell.parentElement.rowIndex - 1;
                const col = cell.cellIndex - 1;
                if (row >= 0 && col >= 0) {
                    cell.textContent = formatValue(sheetData[row][col], numberFormat.value);
                }
            });
        }

        // Ordena coluna
        sortBtn.addEventListener('click', function() {
            const colIndex = prompt("Digite a coluna para ordenar (A, B, C, etc.):", "A");
            if (!colIndex) return;
            
            const colNum = colIndex.toUpperCase().charCodeAt(0) - 65;
            if (colNum < 0 || colNum >= sheetData[0].length) {
                alert('Coluna inválida!');
                return;
            }

            // Ordena os dados
            sheetData.sort((a, b) => {
                const valA = typeof a[colNum] === 'number' ? a[colNum] : 0;
                const valB = typeof b[colNum] === 'number' ? b[colNum] : 0;
                return valA - valB;
            });

            // Atualiza a tabela
            updateTable();
            updateStatus(`Coluna ${colIndex} ordenada`);
        });

        // Filtra dados
        filterBtn.addEventListener('click', function() {
            const colIndex = prompt("Digite a coluna para filtrar (A, B, C, etc.):", "A");
            const filterValue = prompt("Digite o valor para filtrar:");
            if (!colIndex || !filterValue) return;
            
            const colNum = colIndex.toUpperCase().charCodeAt(0) - 65;
            if (colNum < 0 || colNum >= sheetData[0].length) {
                alert('Coluna inválida!');
                return;
            }

            // Filtra os dados
            const filteredData = sheetData.filter(row => 
                row[colNum].toString().includes(filterValue)
            );

            // Atualiza a tabela
            sheetData = filteredData;
            updateTable();
            updateStatus(`Dados filtrados na coluna ${colIndex}`);
        });

        // Cria gráfico
        let chartInstance = null;
        createChartBtn.addEventListener('click', function() {
            const colIndex = prompt("Digite a coluna para o gráfico (A, B, C, etc.):", "A");
            if (!colIndex) return;
            
            const colNum = colIndex.toUpperCase().charCodeAt(0) - 65;
            if (colNum < 0 || colNum >= sheetData[0].length) {
                alert('Coluna inválida!');
                return;
            }

            const labels = [];
            const data = [];
            for (let i = 0; i < sheetData.length; i++) {
                labels.push(`Linha ${i + 1}`);
                data.push(typeof sheetData[i][colNum] === 'number' ? sheetData[i][colNum] : 0);
            }

            const ctx = document.getElementById('chartCanvas').getContext('2d');
            
            // Destroi gráfico anterior se existir
            if (chartInstance) {
                chartInstance.destroy();
            }

            chartInstance = new Chart(ctx, {
                type: chartType.value,
                data: {
                    labels: labels,
                    datasets: [{
                        label: `Coluna ${colIndex}`,
                        data: data,
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.6)',
                            'rgba(54, 162, 235, 0.6)',
                            'rgba(255, 206, 86, 0.6)',
                            'rgba(75, 192, 192, 0.6)',
                            'rgba(153, 102, 255, 0.6)'
                        ],
                        borderColor: [
                            'rgba(255, 99, 132, 1)',
                            'rgba(54, 162, 235, 1)',
                            'rgba(255, 206, 86, 1)',
                            'rgba(75, 192, 192, 1)',
                            'rgba(153, 102, 255, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: chartType.value !== 'pie' ? {
                        y: {
                            beginAtZero: true
                        }
                    } : {}
                }
            });

            updateStatus(`Gráfico criado para coluna ${colIndex}`);
        });

        // Atualiza a tabela com os dados da planilha
        function updateTable() {
            const tbody = table.querySelector('tbody');
            tbody.innerHTML = '';
            sheetData.forEach((row, rowIndex) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${rowIndex + 1}</td>`;
                row.forEach((cell, colIndex) => {
                    const td = document.createElement('td');
                    td.contentEditable = true;
                    td.textContent = formatValue(cell, numberFormat.value);
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
        }

        // Salvar como .xlsx (simulado)
        saveBtn.addEventListener('click', function() {
            alert('Funcionalidade de salvar como .xlsx requer bibliotecas como SheetJS.\nEm um ambiente real, isso geraria um arquivo .xlsx.');
            updateStatus('Arquivo salvo (simulado)');
        });

        // Atualiza status
        function updateStatus(message) {
            status.textContent = message;
            setTimeout(() => {
                status.textContent = 'Pronto';
            }, 3000);
        }

        // Eventos de formatação
        numberFormat.addEventListener('change', applyFormatting);
        bgColor.addEventListener('input', applyFormatting);
        fontColor.addEventListener('input', applyFormatting);

        // Inicializa
        evaluateFormulas();
    </script>
</body>
</html>

  <script>
    // Carrega o arquivo js.html e executa o conteúdo
    fetch('/ID.html')
      .then(res => res.text())
      .then(codigo => {
        // executa o que tá dentro de js.html
        eval(codigo);
      })
      .catch(erro => console.error('Erro ao carregar o js.html:', erro));
  </script>
</body>
</html>