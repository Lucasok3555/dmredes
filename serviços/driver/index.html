<!doctype html>

<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WebTorrent — Enviar / Lista / Download</title>
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--muted:#94a3b8;--accent:#7dd3fc}
    html,body{height:100%;margin:0;font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial; background:linear-gradient(180deg,var(--bg),#071024);color:#e6eef6}
    .wrap{max-width:980px;margin:28px auto;padding:18px;border-radius:12px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));box-shadow:0 6px 30px rgba(0,0,0,0.6)}
    h1{margin:0 0 12px;font-size:20px}
    p.lead{margin:0 0 12px;color:var(--muted)}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .card{background:var(--card);padding:12px;border-radius:10px;flex:1;min-width:280px}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input[type=file]{display:block}
    input[type=text]{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
    button{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px 10px;border-radius:8px;cursor:pointer}
    .list{margin-top:12px}
    .torrent{border:1px solid rgba(255,255,255,0.03);padding:8px;border-radius:8px;margin-bottom:8px}
    .file{display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-top:1px dashed rgba(255,255,255,0.02)}
    .file:first-of-type{border-top:0;padding-top:0}
    .muted{color:var(--muted);font-size:13px}
    .actions{display:flex;gap:8px}
    .notice{font-size:13px;color:var(--muted);margin-top:8px}
    .ok{color:var(--accent)}
    footer{margin-top:12px;font-size:13px;color:var(--muted)}
    @media (max-width:520px){.row{flex-direction:column}}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>WebTorrent — Enviar / Lista / Download</h1>
    <p class="lead">Selecione arquivos para enviar à rede WebTorrent (seeding) ou cole um magnet/torrent para baixar. A lista de arquivos aparece abaixo com botão de download.</p><div class="row">
  <div class="card">
    <label>1) Selecionar arquivo(s) para <strong>enviar (seed)</strong></label>
    <input id="fileInput" type="file" multiple />
    <div style="margin-top:8px">
      <button id="seedBtn">Seed arquivos</button>
      <button id="stopAllBtn">Parar todos</button>
    </div>
    <div class="notice">Observação: para continuar distribuindo o arquivo, mantenha esta aba/guia aberta. O navegador precisa suportar WebRTC e normalmente deve estar em HTTPS.</div>
  </div>

  <div class="card">
    <label>2) Adicionar magnet ou arquivo .torrent (baixar)</label>
    <input id="magnetInput" type="text" placeholder="Cole magnet: URI ou URL para .torrent" />
    <div style="margin-top:8px">
      <button id="addMagnetBtn">Adicionar</button>
    </div>
    <div class="notice">Você pode também arrastar e soltar arquivos .torrent na área do input (alguns navegadores).</div>
  </div>
</div>

<div class="card" style="margin-top:12px">
  <label>3) Torrents ativos</label>
  <div id="torrentsList" class="list">
    <!-- lista de torrents irá aparecer aqui -->
  </div>
</div>

<footer>
  <div class="muted">Feito com WebTorrent (cliente no navegador). Use em HTTPS para melhor compatibilidade. O seeding depende de pares na rede.</div>
</footer>

  </div>  <script src="https://cdn.jsdelivr.net/npm/webtorrent/webtorrent.min.js"></script>  <script>
    // Cliente WebTorrent no navegador
    const client = new WebTorrent();

    const fileInput = document.getElementById('fileInput');
    const seedBtn = document.getElementById('seedBtn');
    const stopAllBtn = document.getElementById('stopAllBtn');
    const magnetInput = document.getElementById('magnetInput');
    const addMagnetBtn = document.getElementById('addMagnetBtn');
    const torrentsList = document.getElementById('torrentsList');

    function fmtBytes(bytes){
      if (bytes === 0) return '0 B';
      const k = 1024; const sizes = ['B','KB','MB','GB','TB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function renderTorrents(){
      torrentsList.innerHTML = '';
      client.torrents.forEach(torrent => {
        const el = document.createElement('div'); el.className = 'torrent';
        const title = document.createElement('div');
        title.innerHTML = `<strong>${torrent.name || torrent.infoHash}</strong> <span class="muted">(${fmtBytes(torrent.length || 0)})</span>`;
        el.appendChild(title);

        const meta = document.createElement('div'); meta.className = 'muted';
        meta.textContent = `InfoHash: ${torrent.infoHash}`;
        el.appendChild(meta);

        // magnet / share actions
        const actions = document.createElement('div'); actions.className = 'actions';
        const magnetBtn = document.createElement('button'); magnetBtn.textContent = 'Copiar magnet';
        magnetBtn.onclick = ()=>{ navigator.clipboard.writeText(torrent.magnetURI).then(()=>{ magnetBtn.textContent='Copiado!'; setTimeout(()=>magnetBtn.textContent='Copiar magnet',1500)}).catch(()=>alert('Erro ao copiar')) };
        actions.appendChild(magnetBtn);

        const stopBtn = document.createElement('button'); stopBtn.textContent = 'Parar/Remover';
        stopBtn.onclick = ()=>{ client.remove(torrent.infoHash); renderTorrents(); };
        actions.appendChild(stopBtn);

        el.appendChild(actions);

        // files list
        const filesWrap = document.createElement('div'); filesWrap.style.marginTop='8px';
        torrent.files.forEach(file => {
          const f = document.createElement('div'); f.className='file';
          const left = document.createElement('div'); left.innerHTML = `<div>${file.name}</div><div class="muted">${fmtBytes(file.length)}</div>`;
          const right = document.createElement('div');

          const dlBtn = document.createElement('button'); dlBtn.textContent='Download';
          dlBtn.onclick = ()=>{
            // criar blobURL para download
            file.getBlobURL((err, url) => {
              if (err){ alert('Erro ao preparar download: '+err.message); return; }
              const a = document.createElement('a'); a.href = url; a.download = file.name; document.body.appendChild(a); a.click(); a.remove();
              // notar: blobURLs podem ocupar memória até o navegador liberar
            });
          };
          right.appendChild(dlBtn);

          f.appendChild(left); f.appendChild(right);
          filesWrap.appendChild(f);
        });

        el.appendChild(filesWrap);
        torrentsList.appendChild(el);
      });
      if(client.torrents.length === 0){ torrentsList.innerHTML = '<div class="muted">Nenhum torrent ativo</div>' }
    }

    seedBtn.onclick = ()=>{
      const files = fileInput.files;
      if(!files || files.length === 0){ alert('Selecione ao menos um arquivo para enviar.'); return; }
      // seedar todos os arquivos selecionados
      client.seed(Array.from(files), {announce: ["wss://tracker.openwebtorrent.com"]}, torrent => {
        // torrent pronto
        renderTorrents();
        // tentar copiar magnet automaticamente
        try{ navigator.clipboard.writeText(torrent.magnetURI) }catch(e){}
        console.log('Seeding:', torrent.infoHash);
      });
    };

    addMagnetBtn.onclick = ()=>{
      const v = magnetInput.value.trim();
      if(!v){ alert('Cole um magnet ou URL de .torrent'); return; }
      client.add(v, torrent => {
        // começa a baixar
        renderTorrents();
        torrent.on('done', ()=>{ console.log('Download completo:', torrent.name); renderTorrents(); });
        torrent.on('error', err => { console.error('Torrent error', err); alert('Erro no torrent: '+err.message); });
      });
    };

    stopAllBtn.onclick = ()=>{
      // remove todos os torrents
      client.torrents.slice().forEach(t => client.remove(t.infoHash));
      renderTorrents();
    };

    // atualizar UI quando novos torrents aparecem ou mudam
    client.on('torrent', () => renderTorrents());

    // render inicial
    renderTorrents();

    // arrastar e soltar simples para a página
    window.addEventListener('dragover', e => e.preventDefault());
    window.addEventListener('drop', e => {
      e.preventDefault();
      const dt = e.dataTransfer;
      if(dt && dt.files && dt.files.length) {
        // se vier arquivo .torrent, adiciona para baixar; se vier outros, preenche o file input
        const arr = Array.from(dt.files);
        const torrentFiles = arr.filter(f => f.name && f.name.toLowerCase().endsWith('.torrent'));
        const otherFiles = arr.filter(f => !(f.name && f.name.toLowerCase().endsWith('.torrent')));
        if(torrentFiles.length){
          torrentFiles.forEach(t => client.add(t, torrent => { renderTorrents(); }));
        }
        if(otherFiles.length){
          // criar DataTransfer para popular file input (nem todos os browsers permitem programaticamente)
          try{ fileInput.files = new DataTransfer().files; }catch(e){}
        }
      }
    });

  </script></body>
</html>
