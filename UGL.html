<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AnonSocial - Rede Social P2P Anônima</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        .post-enter {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .gradient-bg {
            background: linear-gradient(135deg, #6e8efb, #a777e3);
        }
        .post-card {
            transition: all 0.3s ease;
        }
        .post-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .connection-status {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }
        .connection-connected {
            background-color: #10B981;
        }
        .connection-disconnected {
            background-color: #EF4444;
        }
        .video-thumbnail {
            position: relative;
            overflow: hidden;
            border-radius: 8px;
            background-color: #000;
        }
        .video-thumbnail video {
            width: 100%;
            height: auto;
            display: block;
        }
        .video-thumbnail::after {
            content: '\f144';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 40px;
            opacity: 0.8;
            text-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        .video-tab {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 40;
        }
        .video-feed {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            z-index: 50;
            overflow-y: auto;
            display: none;
        }
        .video-container {
            max-width: 600px;
            margin: 20px auto;
            background-color: #111;
            border-radius: 8px;
            overflow: hidden;
        }
        .video-player {
            width: 100%;
            display: block;
        }
        .close-video-feed {
            position: fixed;
            top: 20px;
            right: 20px;
            color: white;
            font-size: 24px;
            cursor: pointer;
            z-index: 51;
        }
        .tab-indicator {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #EF4444;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }
        .recording-indicator {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #EF4444;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            z-index: 100;
            display: none;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .pulse {
            animation: pulse 1.5s infinite;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <header class="gradient-bg text-white rounded-xl shadow-lg mb-8 p-6">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold">AnonSocial</h1>
                    <p class="opacity-80">Sua rede social P2P totalmente anônima</p>
                </div>
                <div class="flex items-center space-x-4">
                    <div id="connectionInfo" class="flex items-center">
                        <span id="connectionStatus" class="connection-status connection-disconnected"></span>
                        <span id="peerCount">0 conexões</span>
                    </div>
                    <button id="themeToggle" class="p-2 rounded-full bg-white bg-opacity-20 hover:bg-opacity-30 transition">
                        <i class="fas fa-moon text-white"></i>
                    </button>
                    <div class="relative">
                        <button id="infoBtn" class="p-2 rounded-full bg-white bg-opacity-20 hover:bg-opacity-30 transition">
                            <i class="fas fa-info-circle text-white"></i>
                        </button>
                        <div id="infoDropdown" class="hidden absolute right-0 mt-2 w-64 bg-white text-gray-800 rounded-lg shadow-lg p-4 z-10">
                            <h3 class="font-bold mb-2">Sobre o AnonSocial</h3>
                            <p class="text-sm mb-2">Todos os posts são compartilhados diretamente entre usuários via P2P.</p>
                            <p class="text-sm">Para conectar com amigos, compartilhe seu ID ou insira o ID deles abaixo.</p>
                            <div class="mt-3">
                                <input type="text" id="peerIdInput" class="w-full px-2 py-1 border border-gray-300 rounded text-sm" placeholder="Cole o ID do amigo">
                                <button id="connectPeerBtn" class="mt-2 w-full bg-purple-600 text-white py-1 px-3 rounded text-sm">Conectar</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Create Post Section -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-xl shadow-lg p-6 sticky top-6">
                    <h2 class="text-xl font-semibold mb-4">Criar Novo Post</h2>
                    <form id="postForm" class="space-y-4">
                        <div>
                            <label for="postContent" class="block text-sm font-medium text-gray-700 mb-1">Mensagem</label>
                            <textarea id="postContent" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="O que você está pensando?"></textarea>
                        </div>
                        
                        <div class="flex items-center space-x-4">
                            <div class="flex-1">
                                <input type="file" id="imageUpload" accept="image/*" class="hidden">
                                <label for="imageUpload" class="w-full block text-center bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 px-4 rounded-lg cursor-pointer transition">
                                    <i class="fas fa-image mr-2"></i> Imagem
                                </label>
                            </div>
                            <div class="flex-1">
                                <button type="button" id="videoRecordBtn" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 px-4 rounded-lg transition">
                                    <i class="fas fa-video mr-2"></i> Vídeo
                                </button>
                            </div>
                        </div>
                        
                        <div id="mediaPreview" class="hidden rounded-lg overflow-hidden relative">
                            <button type="button" id="removeMediaBtn" class="absolute top-2 right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center">
                                <i class="fas fa-times"></i>
                            </button>
                            <img id="imagePreview" class="hidden w-full h-auto">
                            <video id="videoPreview" class="hidden w-full" controls></video>
                        </div>
                        
                        <div class="flex items-center">
                            <input id="anonymousCheck" type="checkbox" class="h-4 w-4 text-purple-600 focus:ring-purple-500 border-gray-300 rounded" checked>
                            <label for="anonymousCheck" class="ml-2 block text-sm text-gray-700">Postar anonimamente</label>
                        </div>
                        <button type="submit" class="w-full gradient-bg text-white py-2 px-4 rounded-lg hover:opacity-90 transition flex items-center justify-center">
                            <i class="fas fa-paper-plane mr-2"></i> Publicar
                        </button>
                    </form>

                    <div class="mt-6 pt-6 border-t border-gray-200">
                        <h3 class="text-lg font-medium mb-3">Conexões P2P</h3>
                        <div class="space-y-3">
                            <div class="flex items-center">
                                <span class="text-sm font-medium mr-2">Seu ID:</span>
                                <span id="myPeerId" class="text-sm bg-gray-100 px-2 py-1 rounded truncate flex-1"></span>
                                <button id="copyPeerIdBtn" class="ml-2 p-1 text-gray-500 hover:text-purple-600">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                            <button id="sharePeerIdBtn" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 px-4 rounded-lg transition flex items-center justify-center">
                                <i class="fas fa-share-alt mr-2"></i> Compartilhar ID
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Feed Section -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-semibold">Feed Compartilhado</h2>
                        <div class="flex items-center space-x-2">
                            <span id="postCount" class="text-sm text-gray-500">0 posts</span>
                            <button id="refreshBtn" class="p-2 text-gray-500 hover:text-purple-600 transition">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                    </div>

                    <div id="feedContainer" class="space-y-4">
                        <!-- Posts will be inserted here -->
                        <div id="emptyFeed" class="text-center py-10">
                            <i class="fas fa-comment-slash text-4xl text-gray-300 mb-3"></i>
                            <p class="text-gray-500">Seu feed está vazio. Crie seu primeiro post!</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Video Tab Button -->
    <div class="video-tab">
        <button id="openVideoFeedBtn" class="bg-purple-600 text-white rounded-full p-4 shadow-lg relative hover:bg-purple-700 transition">
            <i class="fas fa-video text-xl"></i>
            <span id="videoCount" class="tab-indicator hidden">0</span>
        </button>
    </div>

    <!-- Video Feed -->
    <div id="videoFeed" class="video-feed">
        <div class="close-video-feed">
            <i class="fas fa-times"></i>
        </div>
        <div id="videoFeedContainer" class="py-20 px-4">
            <!-- Videos will be inserted here -->
            <div id="emptyVideoFeed" class="text-center py-20">
                <i class="fas fa-video-slash text-4xl text-gray-500 mb-3"></i>
                <p class="text-gray-400">Nenhum vídeo encontrado</p>
            </div>
        </div>
    </div>

    <!-- Recording Indicator -->
    <div id="recordingIndicator" class="recording-indicator">
        <i class="fas fa-circle pulse mr-2"></i> Gravando vídeo...
    </div>

    <!-- Share ID Modal -->
    <div id="shareModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl p-6 w-full max-w-md">
            <h3 class="text-xl font-semibold mb-4">Compartilhar seu ID</h3>
            <p class="mb-4 text-sm">Compartilhe este link com seus amigos para que eles possam se conectar diretamente a você:</p>
            <div class="flex items-center">
                <input type="text" id="shareLink" class="flex-1 px-3 py-2 border border-gray-300 rounded-l-lg" readonly>
                <button id="copyShareLinkBtn" class="px-4 py-2 bg-purple-600 text-white rounded-r-lg hover:bg-purple-700">
                    <i class="fas fa-copy"></i>
                </button>
            </div>
            <div class="mt-4 flex justify-end">
                <button id="closeShareModal" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-100">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Video Recording Modal -->
    <div id="videoModal" class="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50 hidden">
        <div class="w-full max-w-md">
            <div class="relative">
                <video id="videoLivePreview" class="w-full rounded-lg" autoplay muted></video>
                <button id="stopRecordingBtn" class="absolute bottom-4 left-1/2 transform -translate-x-1/2 bg-red-600 text-white rounded-full p-4 shadow-lg hover:bg-red-700 transition">
                    <i class="fas fa-stop"></i>
                </button>
                <div class="absolute top-4 right-4 bg-black bg-opacity-50 text-white px-2 py-1 rounded">
                    <span id="recordingTimer">00:10</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // DOM Elements
            const postForm = document.getElementById('postForm');
            const postContent = document.getElementById('postContent');
            const anonymousCheck = document.getElementById('anonymousCheck');
            const feedContainer = document.getElementById('feedContainer');
            const emptyFeed = document.getElementById('emptyFeed');
            const postCount = document.getElementById('postCount');
            const refreshBtn = document.getElementById('refreshBtn');
            const themeToggle = document.getElementById('themeToggle');
            const infoBtn = document.getElementById('infoBtn');
            const infoDropdown = document.getElementById('infoDropdown');
            const myPeerId = document.getElementById('myPeerId');
            const copyPeerIdBtn = document.getElementById('copyPeerIdBtn');
            const sharePeerIdBtn = document.getElementById('sharePeerIdBtn');
            const shareModal = document.getElementById('shareModal');
            const shareLink = document.getElementById('shareLink');
            const copyShareLinkBtn = document.getElementById('copyShareLinkBtn');
            const closeShareModal = document.getElementById('closeShareModal');
            const peerIdInput = document.getElementById('peerIdInput');
            const connectPeerBtn = document.getElementById('connectPeerBtn');
            const connectionStatus = document.getElementById('connectionStatus');
            const peerCount = document.getElementById('peerCount');
            const imageUpload = document.getElementById('imageUpload');
            const videoRecordBtn = document.getElementById('videoRecordBtn');
            const mediaPreview = document.getElementById('mediaPreview');
            const imagePreview = document.getElementById('imagePreview');
            const videoPreview = document.getElementById('videoPreview');
            const removeMediaBtn = document.getElementById('removeMediaBtn');
            const openVideoFeedBtn = document.getElementById('openVideoFeedBtn');
            const videoFeed = document.getElementById('videoFeed');
            const videoFeedContainer = document.getElementById('videoFeedContainer');
            const emptyVideoFeed = document.getElementById('emptyVideoFeed');
            const closeVideoFeed = document.querySelector('.close-video-feed');
            const videoCount = document.getElementById('videoCount');
            const videoModal = document.getElementById('videoModal');
            const videoLivePreview = document.getElementById('videoLivePreview');
            const stopRecordingBtn = document.getElementById('stopRecordingBtn');
            const recordingTimer = document.getElementById('recordingTimer');
            const recordingIndicator = document.getElementById('recordingIndicator');
            
            // Media variables
            let mediaFile = null;
            let mediaType = null; // 'image' or 'video'
            let mediaUrl = null;
            let mediaStream = null;
            let mediaRecorder = null;
            let recordedChunks = [];
            let recordingInterval = null;
            let recordingSeconds = 10;
            
            // PeerJS variables
            let peer;
            let myId;
            const connections = new Set();
            const connectedPeers = new Set();

            // Theme toggle
            themeToggle.addEventListener('click', function() {
                document.documentElement.classList.toggle('dark');
                const icon = themeToggle.querySelector('i');
                if (document.documentElement.classList.contains('dark')) {
                    icon.classList.remove('fa-moon');
                    icon.classList.add('fa-sun');
                    document.body.classList.add('bg-gray-900');
                    document.body.classList.remove('bg-gray-100');
                } else {
                    icon.classList.remove('fa-sun');
                    icon.classList.add('fa-moon');
                    document.body.classList.remove('bg-gray-900');
                    document.body.classList.add('bg-gray-100');
                }
            });

            // Info dropdown
            infoBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                infoDropdown.classList.toggle('hidden');
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', function(event) {
                if (!infoBtn.contains(event.target) && !infoDropdown.contains(event.target)) {
                    infoDropdown.classList.add('hidden');
                }
            });

            // Image upload
            imageUpload.addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    const file = e.target.files[0];
                    if (file.type.startsWith('image/')) {
                        // Clear any previous media
                        clearMedia();
                        
                        mediaType = 'image';
                        mediaFile = file;
                        mediaUrl = URL.createObjectURL(file);
                        
                        imagePreview.src = mediaUrl;
                        imagePreview.classList.remove('hidden');
                        mediaPreview.classList.remove('hidden');
                        
                        // If there was a video recording, stop it
                        stopRecording();
                    } else {
                        alert('Por favor, selecione um arquivo de imagem válido.');
                    }
                }
            });

            // Video recording
            videoRecordBtn.addEventListener('click', function() {
                // Clear any previous media
                clearMedia();
                
                // Request access to camera
                navigator.mediaDevices.getUserMedia({ 
                    video: true,
                    audio: true
                }).then(function(stream) {
                    mediaStream = stream;
                    videoLivePreview.srcObject = stream;
                    videoModal.classList.remove('hidden');
                    recordingIndicator.style.display = 'flex';
                    
                    // Start recording
                    recordedChunks = [];
                    mediaRecorder = new MediaRecorder(stream, {
                        mimeType: 'video/webm'
                    });
                    
                    mediaRecorder.ondataavailable = function(e) {
                        if (e.data.size > 0) {
                            recordedChunks.push(e.data);
                        }
                    };
                    
                    mediaRecorder.onstop = function() {
                        const blob = new Blob(recordedChunks, {
                            type: 'video/webm'
                        });
                        
                        mediaType = 'video';
                        mediaFile = new File([blob], 'recording.webm', { type: 'video/webm' });
                        mediaUrl = URL.createObjectURL(blob);
                        
                        videoPreview.src = mediaUrl;
                        videoPreview.classList.remove('hidden');
                        mediaPreview.classList.remove('hidden');
                        
                        // Update video feed count
                        updateVideoCount();
                    };
                    
                    mediaRecorder.start();
                    
                    // Start timer
                    recordingSeconds = 10;
                    updateTimerDisplay();
                    recordingInterval = setInterval(function() {
                        recordingSeconds--;
                        updateTimerDisplay();
                        
                        if (recordingSeconds <= 0) {
                            stopRecording();
                        }
                    }, 1000);
                    
                }).catch(function(err) {
                    console.error('Erro ao acessar câmera:', err);
                    alert('Não foi possível acessar a câmera. Por favor, verifique as permissões.');
                });
            });

            // Stop recording
            stopRecordingBtn.addEventListener('click', stopRecording);
            
            function stopRecording() {
                if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                    mediaRecorder.stop();
                }
                
                if (mediaStream) {
                    mediaStream.getTracks().forEach(track => track.stop());
                    mediaStream = null;
                }
                
                if (recordingInterval) {
                    clearInterval(recordingInterval);
                    recordingInterval = null;
                }
                
                videoModal.classList.add('hidden');
                recordingIndicator.style.display = 'none';
            }
            
            function updateTimerDisplay() {
                const minutes = Math.floor(recordingSeconds / 60);
                const seconds = recordingSeconds % 60;
                recordingTimer.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }

            // Remove media
            removeMediaBtn.addEventListener('click', clearMedia);
            
            function clearMedia() {
                mediaFile = null;
                mediaType = null;
                
                if (mediaUrl) {
                    URL.revokeObjectURL(mediaUrl);
                    mediaUrl = null;
                }
                
                imagePreview.classList.add('hidden');
                videoPreview.classList.add('hidden');
                mediaPreview.classList.add('hidden');
                
                // Stop any ongoing recording
                stopRecording();
                
                // Reset file input
                imageUpload.value = '';
            }

            // Open video feed
            openVideoFeedBtn.addEventListener('click', function() {
                videoFeed.style.display = 'block';
                renderVideoFeed();
            });

            // Close video feed
            closeVideoFeed.addEventListener('click', function() {
                videoFeed.style.display = 'none';
            });

            // Initialize PeerJS
            function initializePeer() {
                // Generate a random ID if none exists in localStorage
                const savedPeerId = localStorage.getItem('anonSocialPeerId');
                
                peer = new Peer(savedPeerId || null, {
                    host: '0.peerjs.com',
                    port: 443,
                    path: '/',
                    secure: true,
                    debug: 3
                });

                peer.on('open', function(id) {
                    console.log('My peer ID is: ' + id);
                    myId = id;
                    myPeerId.textContent = id;
                    localStorage.setItem('anonSocialPeerId', id);
                    updateConnectionStatus(true);
                    
                    // Generate share link
                    const currentUrl = new URL(window.location.href);
                    currentUrl.searchParams.set('connect', id);
                    shareLink.value = currentUrl.toString();
                });

                peer.on('connection', function(conn) {
                    console.log('Incoming connection from: ' + conn.peer);
                    setupConnection(conn);
                });

                peer.on('error', function(err) {
                    console.error('PeerJS error:', err);
                    updateConnectionStatus(false);
                    
                    // Try to reconnect if the connection was lost
                    if (err.type === 'peer-unavailable' || err.type === 'network') {
                        setTimeout(initializePeer, 5000);
                    }
                });

                peer.on('disconnected', function() {
                    console.log('Connection lost. Trying to reconnect...');
                    updateConnectionStatus(false);
                    peer.reconnect();
                });

                peer.on('close', function() {
                    console.log('Peer connection closed');
                    updateConnectionStatus(false);
                });
            }

            // Setup a connection with another peer
            function setupConnection(conn) {
                if (connections.has(conn.peer)) {
                    console.log('Already connected to: ' + conn.peer);
                    return;
                }
                
                connections.add(conn.peer);
                connectedPeers.add(conn.peer);
                updatePeerCount();
                
                conn.on('open', function() {
                    console.log('Connected to: ' + conn.peer);
                    
                    // Send our current posts to the new connection
                    const posts = JSON.parse(localStorage.getItem('anonSocialPosts')) || [];
                    if (posts.length > 0) {
                        conn.send({
                            type: 'initial_posts',
                            posts: posts
                        });
                    }
                });

                conn.on('data', function(data) {
                    console.log('Received data from peer:', data);
                    
                    if (data.type === 'new_post') {
                        addPostToFeed(data.post, false);
                        
                        // If it's a video post, update video feed
                        if (data.post.mediaType === 'video') {
                            updateVideoCount();
                        }
                    } else if (data.type === 'initial_posts') {
                        // Merge received posts with our own
                        const existingPosts = JSON.parse(localStorage.getItem('anonSocialPosts')) || [];
                        const existingIds = existingPosts.map(post => post.id);
                        
                        const newPosts = data.posts.filter(post => !existingIds.includes(post.id));
                        if (newPosts.length > 0) {
                            newPosts.forEach(post => {
                                addPostToFeed(post, false);
                                
                                // Count videos
                                if (post.mediaType === 'video') {
                                    updateVideoCount();
                                }
                            });
                            
                            const allPosts = [...existingPosts, ...newPosts];
                            localStorage.setItem('anonSocialPosts', JSON.stringify(allPosts));
                            updatePostCount(allPosts.length);
                        }
                    }
                });

                conn.on('close', function() {
                    console.log('Connection closed with: ' + conn.peer);
                    connections.delete(conn.peer);
                    connectedPeers.delete(conn.peer);
                    updatePeerCount();
                });

                conn.on('error', function(err) {
                    console.error('Connection error with ' + conn.peer + ':', err);
                    connections.delete(conn.peer);
                    connectedPeers.delete(conn.peer);
                    updatePeerCount();
                });
            }

            // Connect to another peer
            function connectToPeer(peerId) {
                if (peerId === myId) {
                    alert('Você não pode se conectar a si mesmo!');
                    return;
                }
                
                if (connections.has(peerId)) {
                    alert('Você já está conectado a este peer!');
                    return;
                }
                
                console.log('Attempting to connect to: ' + peerId);
                const conn = peer.connect(peerId, {
                    reliable: true
                });
                
                setupConnection(conn);
            }

            // Update connection status UI
            function updateConnectionStatus(connected) {
                if (connected) {
                    connectionStatus.classList.remove('connection-disconnected');
                    connectionStatus.classList.add('connection-connected');
                } else {
                    connectionStatus.classList.remove('connection-connected');
                    connectionStatus.classList.add('connection-disconnected');
                }
            }

            // Update peer count UI
            function updatePeerCount() {
                const count = connectedPeers.size;
                peerCount.textContent = `${count} conexão${count !== 1 ? 'ões' : ''}`;
            }

            // Load posts from localStorage
            function loadPosts() {
                const posts = JSON.parse(localStorage.getItem('anonSocialPosts')) || [];
                renderPosts(posts);
                updatePostCount(posts.length);
                
                // Count videos
                const videoPosts = posts.filter(post => post.mediaType === 'video');
                if (videoPosts.length > 0) {
                    videoCount.textContent = videoPosts.length;
                    videoCount.classList.remove('hidden');
                } else {
                    videoCount.classList.add('hidden');
                }
            }

            // Render posts to the feed
            function renderPosts(posts) {
                if (posts.length === 0) {
                    emptyFeed.classList.remove('hidden');
                    feedContainer.innerHTML = '';
                    feedContainer.appendChild(emptyFeed);
                    return;
                }

                emptyFeed.classList.add('hidden');
                feedContainer.innerHTML = '';

                // Sort by timestamp (newest first)
                posts.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                posts.forEach(post => {
                    addPostToFeed(post, true);
                });
            }

            // Render video feed
            function renderVideoFeed() {
                const posts = JSON.parse(localStorage.getItem('anonSocialPosts')) || [];
                const videoPosts = posts.filter(post => post.mediaType === 'video');
                
                if (videoPosts.length === 0) {
                    emptyVideoFeed.classList.remove('hidden');
                    videoFeedContainer.innerHTML = '';
                    videoFeedContainer.appendChild(emptyVideoFeed);
                    return;
                }
                
                emptyVideoFeed.classList.add('hidden');
                videoFeedContainer.innerHTML = '';
                
                // Sort by timestamp (newest first)
                videoPosts.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                videoPosts.forEach(post => {
                    const videoElement = document.createElement('div');
                    videoElement.className = 'video-container mb-8';
                    
                    videoElement.innerHTML = `
                        <div class="p-4 text-white">
                            <div class="flex items-center mb-4">
                                <div class="bg-gray-700 rounded-full w-8 h-8 flex items-center justify-center mr-3">
                                    <i class="fas fa-user-secret text-gray-300"></i>
                                </div>
                                <div>
                                    <p class="font-medium">${post.anonymous ? 'Anônimo' : (post.peerId === myId ? 'Você' : 'Usuário')}</p>
                                    <p class="text-xs text-gray-400">${getTimeAgo(post.timestamp)}</p>
                                </div>
                            </div>
                            ${post.content ? `<p class="mb-4">${post.content}</p>` : ''}
                            <video class="video-player" controls>
                                <source src="${post.mediaUrl}" type="video/webm">
                                Seu navegador não suporta o elemento de vídeo.
                            </video>
                        </div>
                    `;
                    
                    videoFeedContainer.appendChild(videoElement);
                });
            }

            // Update video count
            function updateVideoCount() {
                const posts = JSON.parse(localStorage.getItem('anonSocialPosts')) || [];
                const videoPosts = posts.filter(post => post.mediaType === 'video');
                
                if (videoPosts.length > 0) {
                    videoCount.textContent = videoPosts.length;
                    videoCount.classList.remove('hidden');
                } else {
                    videoCount.classList.add('hidden');
                }
            }

            // Add a single post to the feed
            function addPostToFeed(post, isLocal) {
                if (isLocal && document.querySelector(`[data-id="${post.id}"]`)) {
                    return; // Post already exists in feed
                }
                
                const timeAgo = getTimeAgo(post.timestamp);
                
                const postElement = document.createElement('div');
                postElement.className = 'post-card bg-white border border-gray-200 rounded-lg p-4 post-enter';
                postElement.dataset.id = post.id;
                
                let mediaHtml = '';
                if (post.mediaType === 'image') {
                    mediaHtml = `
                        <div class="my-3">
                            <img src="${post.mediaUrl}" class="w-full h-auto rounded-lg">
                        </div>
                    `;
                } else if (post.mediaType === 'video') {
                    mediaHtml = `
                        <div class="my-3 video-thumbnail">
                            <video src="${post.mediaUrl}" class="w-full h-auto" onclick="event.preventDefault(); event.stopPropagation();"></video>
                        </div>
                    `;
                }
                
                postElement.innerHTML = `
                    <div class="flex items-start mb-3">
                        <div class="bg-gray-200 rounded-full w-10 h-10 flex items-center justify-center mr-3">
                            <i class="fas fa-user-secret text-gray-600"></i>
                        </div>
                        <div>
                            <p class="font-medium">${post.anonymous ? 'Anônimo' : (post.peerId === myId ? 'Você' : 'Usuário')}</p>
                            <p class="text-xs text-gray-500">${timeAgo}</p>
                        </div>
                    </div>
                    ${post.content ? `<p class="text-gray-800 mb-3">${post.content}</p>` : ''}
                    ${mediaHtml}
                    ${post.peerId === myId ? `
                    <div class="flex justify-end">
                        <button class="delete-post text-red-500 hover:text-red-700 text-sm" data-id="${post.id}">
                            <i class="fas fa-trash-alt mr-1"></i> Apagar
                        </button>
                    </div>
                    ` : ''}
                `;
                
                if (isLocal) {
                    feedContainer.prepend(postElement);
                } else {
                    feedContainer.appendChild(postElement);
                }

                // Add event listener to delete button if it's our post
                const deleteBtn = postElement.querySelector('.delete-post');
                if (deleteBtn) {
                    deleteBtn.addEventListener('click', function() {
                        const postId = this.getAttribute('data-id');
                        deletePost(postId);
                    });
                }
                
                // Add click event to video thumbnails to open video feed
                if (post.mediaType === 'video') {
                    const videoThumbnail = postElement.querySelector('.video-thumbnail');
                    if (videoThumbnail) {
                        videoThumbnail.addEventListener('click', function() {
                            videoFeed.style.display = 'block';
                            renderVideoFeed();
                            
                            // Scroll to this video in the feed
                            setTimeout(() => {
                                const videoElements = document.querySelectorAll('.video-container');
                                const index = Array.from(videoElements).findIndex(el => 
                                    el.querySelector('source').src === post.mediaUrl
                                );
                                
                                if (index !== -1) {
                                    videoElements[index].scrollIntoView({ behavior: 'smooth' });
                                }
                            }, 100);
                        });
                    }
                }
            }

            // Calculate time ago
            function getTimeAgo(timestamp) {
                const now = new Date();
                const postDate = new Date(timestamp);
                const seconds = Math.floor((now - postDate) / 1000);
                
                let interval = Math.floor(seconds / 31536000);
                if (interval >= 1) return `${interval} ano${interval > 1 ? 's' : ''} atrás`;
                
                interval = Math.floor(seconds / 2592000);
                if (interval >= 1) return `${interval} mês${interval > 1 ? 'es' : ''} atrás`;
                
                interval = Math.floor(seconds / 86400);
                if (interval >= 1) return `${interval} dia${interval > 1 ? 's' : ''} atrás`;
                
                interval = Math.floor(seconds / 3600);
                if (interval >= 1) return `${interval} hora${interval > 1 ? 's' : ''} atrás`;
                
                interval = Math.floor(seconds / 60);
                if (interval >= 1) return `${interval} minuto${interval > 1 ? 's' : ''} atrás`;
                
                return `${Math.floor(seconds)} segundo${seconds !== 1 ? 's' : ''} atrás`;
            }

            // Update post count
            function updatePostCount(count) {
                postCount.textContent = `${count} post${count !== 1 ? 's' : ''}`;
            }

            // Create a new post
            postForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const content = postContent.value.trim();
                
                // Require either content or media
                if (!content && !mediaFile) {
                    alert('Por favor, adicione um texto ou mídia ao post.');
                    return;
                }
                
                const newPost = {
                    id: Date.now().toString(),
                    content: content,
                    anonymous: anonymousCheck.checked,
                    timestamp: new Date().toISOString(),
                    peerId: myId
                };
                
                // Add media if exists
                if (mediaFile) {
                    newPost.mediaType = mediaType;
                    newPost.mediaUrl = mediaUrl;
                    newPost.mediaFile = mediaFile.name;
                }
                
                // Get existing posts
                const posts = JSON.parse(localStorage.getItem('anonSocialPosts')) || [];
                posts.push(newPost);
                
                // Save to localStorage
                localStorage.setItem('anonSocialPosts', JSON.stringify(posts));
                
                // Add to feed
                addPostToFeed(newPost, true);
                updatePostCount(posts.length);
                
                // Update video count if it's a video
                if (mediaType === 'video') {
                    updateVideoCount();
                }
                
                // Clear form
                postContent.value = '';
                clearMedia();
                
                // Broadcast to all connected peers
                connections.forEach(conn => {
                    if (conn.open) {
                        conn.send({
                            type: 'new_post',
                            post: newPost
                        });
                    }
                });
            });

            // Delete a post
            function deletePost(postId) {
                const posts = JSON.parse(localStorage.getItem('anonSocialPosts')) || [];
                const postIndex = posts.findIndex(post => post.id === postId);
                
                if (postIndex === -1) return;
                
                // Check if it's a video post
                const isVideoPost = posts[postIndex].mediaType === 'video';
                
                // Remove from storage
                const updatedPosts = posts.filter(post => post.id !== postId);
                localStorage.setItem('anonSocialPosts', JSON.stringify(updatedPosts));
                
                // Remove from UI
                const postElement = document.querySelector(`[data-id="${postId}"]`);
                if (postElement) {
                    postElement.remove();
                }
                
                updatePostCount(updatedPosts.length);
                
                // Update video count if it was a video
                if (isVideoPost) {
                    updateVideoCount();
                }
                
                if (updatedPosts.length === 0) {
                    emptyFeed.classList.remove('hidden');
                    feedContainer.appendChild(emptyFeed);
                }
            }

            // Copy peer ID to clipboard
            copyPeerIdBtn.addEventListener('click', function() {
                navigator.clipboard.writeText(myId).then(() => {
                    const originalIcon = copyPeerIdBtn.querySelector('i');
                    originalIcon.classList.replace('fa-copy', 'fa-check');
                    
                    setTimeout(() => {
                        originalIcon.classList.replace('fa-check', 'fa-copy');
                    }, 2000);
                }).catch(err => {
                    console.error('Erro ao copiar ID:', err);
                });
            });

            // Share peer ID
            sharePeerIdBtn.addEventListener('click', function() {
                shareModal.classList.remove('hidden');
            });

            closeShareModal.addEventListener('click', function() {
                shareModal.classList.add('hidden');
            });

            copyShareLinkBtn.addEventListener('click', function() {
                navigator.clipboard.writeText(shareLink.value).then(() => {
                    const originalText = copyShareLinkBtn.innerHTML;
                    copyShareLinkBtn.innerHTML = '<i class="fas fa-check"></i>';
                    
                    setTimeout(() => {
                        copyShareLinkBtn.innerHTML = originalText;
                    }, 2000);
                }).catch(err => {
                    console.error('Erro ao copiar link:', err);
                });
            });

            // Connect to peer button
            connectPeerBtn.addEventListener('click', function() {
                const peerId = peerIdInput.value.trim();
                if (peerId) {
                    connectToPeer(peerId);
                    peerIdInput.value = '';
                    infoDropdown.classList.add('hidden');
                }
            });

            // Refresh feed
            refreshBtn.addEventListener('click', function() {
                loadPosts();
                // Add animation to refresh button
                refreshBtn.classList.add('animate-spin');
                setTimeout(() => {
                    refreshBtn.classList.remove('animate-spin');
                }, 1000);
            });

            // Check for connect parameter in URL
            function checkUrlForPeerId() {
                const urlParams = new URLSearchParams(window.location.search);
                const peerId = urlParams.get('connect');
                
                if (peerId) {
                    // Remove the parameter from URL without reloading
                    window.history.replaceState({}, document.title, window.location.pathname);
                    
                    // Connect to the peer
                    setTimeout(() => {
                        connectToPeer(peerId);
                    }, 2000); // Give some time for peer to initialize
                }
            }

            // Initialize
            initializePeer();
            loadPosts();
            checkUrlForPeerId();
        });
    </script>
</body>
</html>

  <script>
    function connectToSiteB() {
      fetch('https://lucasok3555.github.io/Lucasweb/apicloud.js ', {
        method: 'GET',
        credentials: 'include' // Importante para incluir cookies nas requisições
      })
      .then(response => response.json())
      .then(data => {
        console.log('Resposta do Site B:', data);
      })
      .catch(err => {
        console.error('Erro ao conectar com Site B:', err);
      });
    }
  </script>
</body>
</html>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-XMSDMJ0NRP"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-XMSDMJ0NRP');
</script>







